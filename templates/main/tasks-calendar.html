{% extends 'base.html' %}

{% block title %}Task Calendar - AI Taskboard{% endblock %}

{% block extra_css %}
<style>
    :root {
        --high-priority: #f87171;
        --medium-priority: #fbbf24;
        --low-priority: #34d399;
        --urgent-priority: #dc2626;
        --default-priority: #60a5fa;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #e5e7eb;
        width: 100%;
    }

    .calendar-day {
        min-height: 120px;
        background-color: white;
        border: 1px solid #e5e7eb;
        position: relative;
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    .calendar-day-header {
        text-align: right;
        padding: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .calendar-event {
        font-size: 0.75rem;
        padding: 2px 6px;
        margin: 2px 0;
        border-radius: 4px;
        cursor: pointer;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        transition: all 0.2s ease;
        max-width: 100%;
        box-sizing: border-box;
    }

    .calendar-event:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .calendar-event.more-events {
        background-color: #f3f4f6 !important;
        color: #6b7280 !important;
        font-style: italic;
        font-size: 0.75rem;
        border: 1px dashed #d1d5db;
        transition: all 0.2s ease;
    }
    
    .calendar-event.more-events:hover {
        background-color: #e5e7eb !important;
        color: #374151 !important;
        border-color: #9ca3af;
        transform: none;
        box-shadow: none;
    }
    
    .dark .calendar-event.more-events {
        background-color: #374151 !important;
        color: #9ca3af !important;
        border-color: #4b5563;
    }
    
    .dark .calendar-event.more-events:hover {
        background-color: #4b5563 !important;
        color: #d1d5db !important;
        border-color: #6b7280;
    }

    .priority-urgent {
        background-color: var(--urgent-priority);
        color: white;
    }

    .priority-high {
        background-color: var(--high-priority);
        color: white;
    }

    .priority-medium {
        background-color: var(--medium-priority);
        color: white;
    }

    .priority-low {
        background-color: var(--low-priority);
        color: white;
    }

    .status-in_progress {
        background-color: #3b82f6;
        color: white;
    }
    
    .status-todo {
        background-color: #6b7280;
        color: white;
    }
    
    .status-completed {
        background-color: #10b981;
        color: white;
    }
    
    .calendar-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 100%;
        max-width: 100%;
    }
    
    .dark .calendar-container {
        background-color: #1f2937;
    }
    
    /* Popup styles for better text handling */
    .popup-task-item {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
    }
    
    .popup-description {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
        overflow: hidden;
    }

    .priority-default {
        background-color: var(--default-priority);
        color: white;
    }

    .today {
        background-color: #dbeafe;
    }

    .current-day {
        background-color: #3b82f6;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .other-month {
        background-color: #f9fafb;
        color: #9ca3af;
    }

    .event-task {
        border-left: 3px solid #3b82f6;
    }

    .drawer {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }

    .drawer-open {
        transform: translateX(0);
    }

    .week-view .calendar-day {
        min-height: 600px;
    }

    .day-view .calendar-day {
        min-height: 800px;
    }

    @media (max-width: 768px) {
        .calendar-container {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: auto;
        }
        
        .main-content {
            padding: 1rem;
        }
        
        .calendar-day {
            min-height: 80px;
        }
    }

    .calendar-day:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }

    .dark .calendar-day {
        background-color: #1f2937;
        border-color: #374151;
    }

    .dark .other-month {
        background-color: #111827;
        color: #6b7280;
    }

    .dark .today {
        background-color: #1e3a8a;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    
    <!-- Main Content -->
    <div class="main-content flex-1 overflow-auto p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="current-month">
                    {{ current_date|date:"F Y" }}
                </h2>
                <div class="flex space-x-3 mt-2">
                    <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm" onclick="goToToday()">Today</button>
                    <button class="text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 text-sm font-medium" onclick="goToTasksMonth()">Go to Tasks (Sep 2025)</button>
                </div>
            </div>
            
            <div class="flex space-x-2 view-options">
                <button class="px-4 py-2 rounded-md bg-blue-500 text-white" onclick="switchView('month')">Month</button>
                <button class="px-4 py-2 rounded-md border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" onclick="switchView('week')">Week</button>
                <button class="px-4 py-2 rounded-md border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" onclick="switchView('day')">Day</button>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="openTaskModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm font-medium transition-colors duration-200">
                    + Add Task
                </button>
            </div>
            
            <div class="flex space-x-2">
                <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400" onclick="navigatePeriod(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400" onclick="navigatePeriod(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Month View (Default) -->
        <div id="month-calendar" class="calendar-view">
            <div class="grid grid-cols-7 gap-1 text-center bg-gray-100 dark:bg-gray-700 py-2 font-medium text-gray-700 dark:text-gray-300">
                <div>Monday</div>
                <div>Tuesday</div>
                <div>Wednesday</div>
                <div>Thursday</div>
                <div>Friday</div>
                <div>Saturday</div>
                <div>Sunday</div>
            </div>
            <div class="calendar-grid" id="month-grid"></div>
        </div>
        
        <!-- Week View -->
        <div id="week-calendar" class="calendar-view hidden">
            <div class="grid grid-cols-7 gap-1 text-center bg-gray-100 dark:bg-gray-700 py-2 font-medium text-gray-700 dark:text-gray-300">
                <div>Monday</div>
                <div>Tuesday</div>
                <div>Wednesday</div>
                <div>Thursday</div>
                <div>Friday</div>
                <div>Saturday</div>
                <div>Sunday</div>
            </div>
            <div class="calendar-grid week-view" id="week-grid"></div>
        </div>
        
        <!-- Day View -->
        <div id="day-calendar" class="calendar-view hidden">
            <div class="grid grid-cols-1 gap-1 text-center bg-gray-100 dark:bg-gray-700 py-2 font-medium text-gray-700 dark:text-gray-300">
                <div id="day-header">{{ today|date:"l, F j, Y" }}</div>
            </div>
            <div class="calendar-grid day-view" id="day-grid"></div>
        </div>
    </div>
</div>

<!-- Task Details Drawer -->
<div id="task-drawer" class="drawer fixed top-0 right-0 h-full w-96 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-lg z-50">
    <div class="p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Event Details</h3>
            <button id="close-drawer" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="task-details-content">
            <!-- Event details will be populated here -->
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="taskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Add Task</h3>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form method="post" action="{% url 'main:task_crud' %}" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="taskTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Task Title</label>
                    <input type="text" id="taskTitle" name="title" required class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <textarea id="taskDescription" name="description" rows="3" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm text-gray-900 dark:text-gray-100"></textarea>
                </div>
                
                <div>
                    <label for="taskDeadline" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deadline</label>
                    <input type="datetime-local" id="taskDeadline" name="deadline" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label for="taskPriority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                    <select id="taskPriority" name="priority" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm text-gray-900 dark:text-gray-100">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm font-medium transition-colors duration-200">
                        Create Task
                    </button>
                    <button type="button" onclick="closeTaskModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 dark:text-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 py-2 px-4 rounded-md text-sm font-medium transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Calendar state
    let currentDate = new Date('{{ current_date|date:"Y-m-d" }}');
    let currentView = 'month';
    let events = {{ calendar_events|default:"[]"|safe }};
    
    console.log(`Loaded ${events.length} calendar events:`, events);

    // Sort tasks by status and priority
    function sortTasks(tasks) {
        const statusOrder = {
            'in_progress': 1,
            'todo': 2,
            'completed': 3
        };
        
        const priorityOrder = {
            'urgent': 1,
            'high': 2,
            'medium': 3,
            'low': 4
        };
        
        return tasks.sort((a, b) => {
            // First sort by status
            const statusA = statusOrder[a.status] || 999;
            const statusB = statusOrder[b.status] || 999;
            
            if (statusA !== statusB) {
                return statusA - statusB;
            }
            
            // Then sort by priority
            const priorityA = priorityOrder[a.priority] || 999;
            const priorityB = priorityOrder[b.priority] || 999;
            
            return priorityA - priorityB;
        });
    }

    // DOM elements
    let monthGrid, weekGrid, dayGrid, currentMonthElement, miniCalendarMonth, taskDrawer, closeDrawerBtn;

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        // Get DOM elements after page loads
        monthGrid = document.getElementById('month-grid');
        weekGrid = document.getElementById('week-grid');
        dayGrid = document.getElementById('day-grid');
        currentMonthElement = document.getElementById('current-month');
        miniCalendarMonth = document.getElementById('mini-calendar-month');
        taskDrawer = document.getElementById('task-drawer');
        closeDrawerBtn = document.getElementById('close-drawer');
        
        // Check if all essential elements exist
        if (monthGrid && weekGrid && dayGrid && currentMonthElement) {
        setupEventListeners();
        renderCalendar();
        renderMiniCalendar();
        } else {
            console.error('Some calendar elements not found');
            console.log('Missing elements:', {
                monthGrid: !!monthGrid,
                weekGrid: !!weekGrid,
                dayGrid: !!dayGrid,
                currentMonthElement: !!currentMonthElement
            });
        }
    });

    // Setup event listeners
    function setupEventListeners() {
        // Only add event listeners for elements that exist
        if (closeDrawerBtn) {
        closeDrawerBtn.addEventListener('click', closeTaskDrawer);
        }
        
        // Close drawer when clicking outside (only if drawer exists)
        if (taskDrawer) {
        document.addEventListener('click', function(e) {
            if (!taskDrawer.contains(e.target) && !e.target.closest('.calendar-event')) {
                closeTaskDrawer();
            }
        });
        }
    }

    // Navigate months
    function navigateMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        renderCalendar();
        renderMiniCalendar();
        updateURL();
    }

    // Navigate periods (weeks/days)
    function navigatePeriod(direction) {
        if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() + direction);
        } else if (currentView === 'week') {
            currentDate.setDate(currentDate.getDate() + (direction * 7));
        } else if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() + direction);
        }
        renderCalendar();
        updateURL();
    }

    // Go to today
    function goToToday() {
        currentDate = new Date();
        renderCalendar();
        renderMiniCalendar();
        updateURL();
    }
    
    // Go to September 2025 (where tasks are scheduled)
    function goToTasksMonth() {
        currentDate = new Date(2025, 8, 1); // September 2025 (month is 0-indexed)
        renderCalendar();
        renderMiniCalendar();
        updateURL();
    }

    // Switch calendar view
    function switchView(view) {
        currentView = view;
        
        // Hide all views
        document.querySelectorAll('.calendar-view').forEach(v => v.classList.add('hidden'));
        
        // Show selected view
        document.getElementById(`${view}-calendar`).classList.remove('hidden');
        
        // Update button states
        document.querySelectorAll('.view-options button').forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('border', 'border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        });
        
        document.querySelector(`[onclick="switchView('${view}')"]`).classList.remove('border', 'border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        document.querySelector(`[onclick="switchView('${view}')"]`).classList.add('bg-blue-500', 'text-white');
        
        renderCalendar();
    }

    // Render calendar based on current view
    function renderCalendar() {
        if (currentView === 'month') {
            renderMonthView();
        } else if (currentView === 'week') {
            renderWeekView();
        } else if (currentView === 'day') {
            renderDayView();
        }
    }

    // Render month view
    function renderMonthView() {
        if (!currentMonthElement || !monthGrid) {
            console.error('Required elements not found for month view');
            return;
        }
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        currentMonthElement.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        // Adjust to start from Monday (0 = Sunday, 1 = Monday, etc.)
        const dayOfWeek = firstDay.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday (0), subtract 6 days to get to Monday
        startDate.setDate(startDate.getDate() - daysToSubtract);
        
        monthGrid.innerHTML = '';
        
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            if (date.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            if (isToday(date)) {
                dayElement.classList.add('today');
            }
            
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = date.getDate();
            
            if (isToday(date)) {
                header.innerHTML = `<span class="current-day">${date.getDate()}</span>`;
            }
            
            dayElement.appendChild(header);
            
            // Add events for this date
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const dayEvents = events.filter(event => event.date === dateString);
            
            // Sort events by status and priority
            const sortedEvents = sortTasks(dayEvents);
            
            // Show max 3 events, then show "+X more" if there are more
            const maxEvents = 3;
            const visibleEvents = sortedEvents.slice(0, maxEvents);
            const remainingCount = sortedEvents.length - maxEvents;
            
            visibleEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `calendar-event priority-${event.priority} event-${event.type}`;
                eventElement.textContent = event.title;
                eventElement.addEventListener('click', () => showEventDetails(event));
                dayElement.appendChild(eventElement);
            });
            
            // Add "+X more" button if there are more events
            if (remainingCount > 0) {
                const moreButton = document.createElement('div');
                moreButton.className = 'calendar-event more-events bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600';
                moreButton.textContent = `+${remainingCount} more`;
                moreButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAllTasksForDate(dateString, sortedEvents);
                });
                dayElement.appendChild(moreButton);
            }
            
            monthGrid.appendChild(dayElement);
        }
    }

    // Render week view
    function renderWeekView() {
        if (!weekGrid) {
            console.error('Week grid element not found');
            return;
        }
        
        const startOfWeek = new Date(currentDate);
        // Adjust to start from Monday
        const dayOfWeek = currentDate.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday (0), subtract 6 days to get to Monday
        startOfWeek.setDate(currentDate.getDate() - daysToSubtract);
        
        weekGrid.innerHTML = '';
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            if (isToday(date)) {
                dayElement.classList.add('today');
            }
            
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            if (isToday(date)) {
                header.innerHTML = `<span class="current-day">${date.getDate()}</span>`;
            }
            
            dayElement.appendChild(header);
            
            // Add events for this date
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const dayEvents = events.filter(event => event.date === dateString);
            
            // Sort events by status and priority
            const sortedEvents = sortTasks(dayEvents);
            
            // Show max 3 events, then show "+X more" if there are more
            const maxEvents = 3;
            const visibleEvents = sortedEvents.slice(0, maxEvents);
            const remainingCount = sortedEvents.length - maxEvents;
            
            visibleEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `calendar-event priority-${event.priority} event-${event.type} p-2 mb-1`;
                eventElement.innerHTML = `
                    <div class="font-medium">${event.title}</div>
                    <div class="text-xs opacity-75">${event.project}</div>
                `;
                eventElement.addEventListener('click', () => showEventDetails(event));
                dayElement.appendChild(eventElement);
            });
            
            // Add "+X more" button if there are more events
            if (remainingCount > 0) {
                const moreButton = document.createElement('div');
                moreButton.className = 'calendar-event more-events bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-2 mb-1';
                moreButton.textContent = `+${remainingCount} more`;
                moreButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAllTasksForDate(dateString, sortedEvents);
                });
                dayElement.appendChild(moreButton);
            }
            
            weekGrid.appendChild(dayElement);
        }
    }

    // Render day view
    function renderDayView() {
        if (!dayGrid) {
            console.error('Day grid element not found');
            return;
        }
        
        const date = currentDate;
        const dayHeader = document.getElementById('day-header');
        if (dayHeader) {
            dayHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        dayGrid.innerHTML = '';
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Add events for this date
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const dayEvents = events.filter(event => event.date === dateString);
        
        // Sort events by status and priority
        const sortedEvents = sortTasks(dayEvents);
        
        // Show max 3 events, then show "+X more" if there are more
        const maxEvents = 3;
        const visibleEvents = sortedEvents.slice(0, maxEvents);
        const remainingCount = sortedEvents.length - maxEvents;
        
        visibleEvents.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = `calendar-event priority-${event.priority} event-${event.type} p-3 mb-2`;
            eventElement.innerHTML = `
                <div class="font-medium">${event.title}</div>
                <div class="text-sm opacity-75">${event.project} • ${event.assignee}</div>
                ${event.description ? `<div class="text-xs opacity-60 mt-1">${event.description}</div>` : ''}
            `;
            eventElement.addEventListener('click', () => showEventDetails(event));
            dayElement.appendChild(eventElement);
        });
        
        // Add "+X more" button if there are more events
        if (remainingCount > 0) {
            const moreButton = document.createElement('div');
            moreButton.className = 'calendar-event more-events bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-3 mb-2';
            moreButton.textContent = `+${remainingCount} more tasks`;
            moreButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showAllTasksForDate(dateString, dayEvents);
            });
            dayElement.appendChild(moreButton);
        }
        
        dayGrid.appendChild(dayElement);
    }

    // Render mini calendar
    function renderMiniCalendar() {
        if (!miniCalendarMonth) {
            // Mini calendar was removed with sidebar, so just return silently
            return;
        }
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        miniCalendarMonth.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        const miniCalendarDays = document.getElementById('mini-calendar-days');
        miniCalendarDays.innerHTML = '';
        
        for (let i = 0; i < 35; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'p-1 text-xs cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 rounded';
            
            if (date.getMonth() !== month) {
                dayElement.classList.add('text-gray-400');
            }
            
            if (isToday(date)) {
                dayElement.classList.add('font-bold', 'text-blue-600', 'bg-blue-100', 'dark:bg-blue-900');
            }
            
            dayElement.textContent = date.getDate();
            dayElement.addEventListener('click', () => {
                currentDate = date;
                renderCalendar();
            });
            miniCalendarDays.appendChild(dayElement);
        }
    }

    // Check if date is today
    function isToday(date) {
        const today = new Date();
        return date.getDate() === today.getDate() && 
               date.getMonth() === today.getMonth() && 
               date.getFullYear() === today.getFullYear();
    }

    // Show event details in drawer
    function showEventDetails(event) {
        if (!taskDrawer) {
            // If no drawer, show details in a popup instead
            showAllTasksForDate(event.date, [event]);
            return;
        }
        
        const content = document.getElementById('task-details-content');
        content.innerHTML = `
            <div class="space-y-6">
                <!-- Header Section -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                    <h4 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">${event.title}</h4>
                    <div class="flex items-center space-x-3">
                        <span class="px-2 py-1 rounded text-xs status-${event.status}">${event.status.replace('_', ' ')}</span>
                        <span class="px-2 py-1 rounded text-xs priority-${event.priority}">${event.priority}</span>
                        ${event.is_overdue ? '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Overdue</span>' : ''}
                    </div>
                </div>
                
                <!-- Basic Information -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Type:</span>
                        <p class="text-gray-800 dark:text-white capitalize">${event.type.replace('_', ' ')}</p>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Project:</span>
                        <p class="text-gray-800 dark:text-white">${event.project}</p>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Date:</span>
                        <p class="text-gray-800 dark:text-white">${new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    ${event.time ? `
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Time:</span>
                        <p class="text-gray-800 dark:text-white">${event.time}</p>
                    </div>
                    ` : ''}
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Creator:</span>
                        <p class="text-gray-800 dark:text-white">${event.creator || 'Unknown'}</p>
                    </div>
                    ${event.assignee ? `
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 font-medium">Assignee:</span>
                        <p class="text-gray-800 dark:text-white">${event.assignee}</p>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Description -->
                ${event.description ? `
                <div>
                    <span class="text-gray-500 dark:text-gray-400 font-medium">Description:</span>
                    <p class="text-gray-800 dark:text-white mt-1 popup-description">${event.description}</p>
                </div>
                ` : ''}
                
                <!-- Notes -->
                ${event.notes ? `
                <div>
                    <span class="text-gray-500 dark:text-gray-400 font-medium">Notes:</span>
                    <p class="text-gray-800 dark:text-white mt-1 popup-description">${event.notes}</p>
                </div>
                ` : ''}
                
                <!-- Time Tracking -->
                ${event.actual_hours || event.estimated_minutes ? `
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h5 class="text-gray-500 dark:text-gray-400 font-medium mb-2">Time Tracking</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        ${event.actual_hours ? `
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Actual Hours:</span>
                            <p class="text-gray-800 dark:text-white">${event.actual_hours} hours</p>
                        </div>
                        ` : ''}
                        ${event.estimated_minutes ? `
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Estimated Time:</span>
                            <p class="text-gray-800 dark:text-white">${event.estimated_minutes} minutes</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- Daily Task Specific Info -->
                ${event.type === 'daily_task' ? `
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h5 class="text-gray-500 dark:text-gray-400 font-medium mb-2">Daily Task Details</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Scheduled Days:</span>
                            <p class="text-gray-800 dark:text-white">${event.scheduled_days ? event.scheduled_days.map(day => ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day]).join(', ') : 'Not specified'}</p>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Active:</span>
                            <p class="text-gray-800 dark:text-white">${event.is_active ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Timestamps -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h5 class="text-gray-500 dark:text-gray-400 font-medium mb-2">Timestamps</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Created:</span>
                            <p class="text-gray-800 dark:text-white">${event.created_at || 'Unknown'}</p>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Last Updated:</span>
                            <p class="text-gray-800 dark:text-white">${event.updated_at || 'Unknown'}</p>
                        </div>
                        ${event.completed_at ? `
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Completed:</span>
                            <p class="text-gray-800 dark:text-white">${event.completed_at}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Task ID -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 text-xs text-gray-500 dark:text-gray-400">
                    ${event.type === 'task' ? `Task ID: ${event.task_id}` : `Daily Task ID: ${event.daily_task_id}`}
                </div>
            </div>
        `;
        
        if (taskDrawer) {
        taskDrawer.classList.add('drawer-open');
        }
    }

    // Close task drawer
    function closeTaskDrawer() {
        if (taskDrawer) {
        taskDrawer.classList.remove('drawer-open');
        }
    }
    
    // Show all tasks for a specific date in a popup
    function showAllTasksForDate(dateString, allEvents) {
        const formattedDate = new Date(dateString).toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">All Tasks - ${formattedDate}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <div class="space-y-3">
                        ${allEvents.map(event => `
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer popup-task-item" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-medium text-gray-800 dark:text-white">${event.title}</h4>
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 rounded text-xs status-${event.status}">${event.status.replace('_', ' ')}</span>
                                        <span class="px-2 py-1 rounded text-xs priority-${event.priority}">${event.priority}</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    <div>
                                        <span class="font-medium">Project:</span> ${event.project}
                                    </div>
                                    <div>
                                        <span class="font-medium">Assignee:</span> ${event.assignee}
                                    </div>
                                    <div>
                                        <span class="font-medium">Time:</span> ${event.time}
                                    </div>
                                    <div>
                                        <span class="font-medium">Type:</span> ${event.type}
                                    </div>
                                </div>
                                ${event.description ? `
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 popup-description">
                                    <span class="font-medium">Description:</span> ${event.description}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // Modal functions
    function openTaskModal() {
        document.getElementById('taskModal').classList.remove('hidden');
    }

    function closeTaskModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }

    // Update URL parameters
    function updateURL() {
        const url = new URL(window.location);
        url.searchParams.set('year', currentDate.getFullYear());
        url.searchParams.set('month', currentDate.getMonth() + 1);
        window.history.replaceState({}, '', url);
    }
</script>
{% endblock %}
