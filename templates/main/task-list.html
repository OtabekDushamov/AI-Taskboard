{% extends 'base.html' %}

{% block title %}Global Tasks Manager - AI Taskboard{% endblock %}

{% block extra_css %}
<style>
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .chip {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .priority-high {
        background-color: #fef2f2;
        color: #991b1b;
    }
    .priority-medium {
        background-color: #fefce8;
        color: #a16207;
    }
    .priority-low {
        background-color: #f0fdf4;
        color: #166534;
    }
    .priority-urgent {
        background-color: #fef2f2;
        color: #991b1b;
    }
    .status-todo {
        background-color: #f3f4f6;
        color: #374151;
    }
    .status-in_progress {
        background-color: #dbeafe;
        color: #1e40af;
    }
    .status-review {
        background-color: #fefce8;
        color: #a16207;
    }
    .status-completed {
        background-color: #f0fdf4;
        color: #166534;
    }
    .date-overdue {
        @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
    }
    .date-due-today {
        @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
    }
    .date-due-soon {
        @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200;
    }
    .date-due-later {
        @apply bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200;
    }
    .checkbox-cell {
        @apply px-4 py-4 whitespace-nowrap;
        width: 50px;
    }
    [type="checkbox"] {
        @apply h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700;
    }
    
    /* Form input with proper Bootstrap-like padding */
    .form-input {
        @apply w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500;
    }
    
    /* Custom dropdown styles */
    .dropdown {
        position: relative;
        display: inline-block;
        width: 100%;
    }
    
    .dropdown-toggle {
        @apply w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 cursor-pointer flex items-center justify-between;
    }
    
    .dropdown-menu {
        @apply absolute z-50 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        top: 100%;
        left: 0;
        right: 0;
    }
    
    .dropdown-menu.show {
        display: block !important;
    }
    
    .dropdown-item {
        @apply block w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer;
    }
    
    .dropdown-item.selected {
        @apply bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300;
    }
    
    
    /* Card view styles */
    .card-view {
        display: none;
    }
    
    .card-view.active {
        display: block;
    }
    
    .table-view.active {
        display: block;
    }
    
    .table-view {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen">
    <!-- Header -->
    <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 mb-6">
        <div class="flex justify-between items-center">
            <div class="flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Global Tasks</h1>
                <p class="text-gray-600 dark:text-gray-400">{{ total_tasks }} tasks total</p>
            </div>
            <div class="flex items-center space-x-4 flex-shrink-0">
                <a href="{% url 'main:task_crud' %}" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors duration-200 whitespace-nowrap">
                    <i class="fas fa-plus mr-2"></i>New Task
                </a>
                <button id="saveFilterBtn" class="px-4 py-2 border border-indigo-600 text-indigo-600 dark:text-indigo-400 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors duration-200 whitespace-nowrap">
                    <i class="fas fa-save mr-2"></i>Save Filter
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Toolbar -->
    <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div>
                    <div class="relative">
                        <input type="text" id="search" placeholder="Search tasks..." class="form-input">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="statusFilter">
                        <span id="statusFilterText">All Statuses</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="statusFilterMenu">
                        <div class="dropdown-item" data-value="">All Statuses</div>
                        <div class="dropdown-item" data-value="todo">To Do</div>
                        <div class="dropdown-item" data-value="in_progress">In Progress</div>
                        <div class="dropdown-item" data-value="review">Review</div>
                        <div class="dropdown-item" data-value="completed">Completed</div>
                    </div>
                </div>

                <!-- Priority Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="priorityFilter">
                        <span id="priorityFilterText">All Priorities</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="priorityFilterMenu">
                        <div class="dropdown-item" data-value="">All Priorities</div>
                        <div class="dropdown-item" data-value="urgent">Urgent</div>
                        <div class="dropdown-item" data-value="high">High</div>
                        <div class="dropdown-item" data-value="medium">Medium</div>
                        <div class="dropdown-item" data-value="low">Low</div>
                    </div>
                </div>
            </div>

            <!-- Additional Filters Row -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <!-- Project Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="projectFilter">
                        <span id="projectFilterText">All Projects</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="projectFilterMenu">
                        <div class="dropdown-item" data-value="">All Projects</div>
                        {% for project in projects %}
                        <div class="dropdown-item" data-value="{{ project.id }}">{{ project.name }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Assignee Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="assigneeFilter">
                        <span id="assigneeFilterText">All Assignees</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="assigneeFilterMenu">
                        <div class="dropdown-item" data-value="">All Assignees</div>
                        {% for user in users %}
                        <div class="dropdown-item" data-value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Due Date Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="dueDateFilter">
                        <span id="dueDateFilterText">All Dates</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="dueDateFilterMenu">
                        <div class="dropdown-item" data-value="">All Dates</div>
                        <div class="dropdown-item" data-value="overdue">Overdue</div>
                        <div class="dropdown-item" data-value="today">Due Today</div>
                        <div class="dropdown-item" data-value="week">Due This Week</div>
                        <div class="dropdown-item" data-value="month">Due This Month</div>
                    </div>
                </div>

                <!-- Tags Filter -->
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" data-dropdown="tagsFilter">
                        <span id="tagsFilterText">All Tags</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="tagsFilterMenu">
                        <div class="dropdown-item" data-value="">All Tags</div>
                        <div class="dropdown-item" data-value="frontend">Frontend</div>
                        <div class="dropdown-item" data-value="backend">Backend</div>
                        <div class="dropdown-item" data-value="design">Design</div>
                        <div class="dropdown-item" data-value="testing">Testing</div>
                    </div>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex space-x-2">
                    <button id="clearFilters" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200">
                        Clear All
                    </button>
                    <button id="applyFilters" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors duration-200">
                        Apply Filters
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">View:</span>
                    <button id="tableViewBtn" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors duration-200">Table</button>
                    <button id="cardViewBtn" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200">Cards</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Table View -->
        <div id="tableView" class="table-view active">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="checkbox-cell" style="padding-left: 18px;">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Task
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Status
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Priority
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Assignee
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Due Date
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    Project
                                    <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for task in tasks %}
                            <tr class="task-item hover:bg-gray-50 dark:hover:bg-gray-700{% if task.status == 'completed' %} opacity-50 line-through{% endif %}">
                                <td class="checkbox-cell" style="padding-left: 18px;">
                                    <input type="checkbox" 
                                           class="task-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700" 
                                           data-task-id="{{ task.id }}"
                                           {% if task.status == 'completed' %}checked{% endif %}>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full {% if task.priority == 'urgent' %}bg-red-100 dark:bg-red-900/30{% elif task.priority == 'high' %}bg-orange-100 dark:bg-orange-900/30{% elif task.priority == 'medium' %}bg-yellow-100 dark:bg-yellow-900/30{% else %}bg-green-100 dark:bg-green-900/30{% endif %} flex items-center justify-center">
                                                <i class="fas fa-tasks {% if task.priority == 'urgent' %}text-red-600 dark:text-red-400{% elif task.priority == 'high' %}text-orange-600 dark:text-orange-400{% elif task.priority == 'medium' %}text-yellow-600 dark:text-yellow-400{% else %}text-green-600 dark:text-green-400{% endif %}"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                <a href="{% url 'main:task_detail' task.id %}" class="hover:text-indigo-600 dark:hover:text-indigo-400">{{ task.title }}</a>
                                            </div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">{{ task.description|truncatechars:40 }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    <span class="chip status-{{ task.status|default:'todo' }}">{{ task.get_status_display }}</span>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    <span class="chip priority-{{ task.priority|default:'medium' }}">{{ task.get_priority_display }}</span>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        {% for assignee in task.assignees.all|slice:":1" %}
                                        <div class="h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ assignee.first_name|first|upper }}{{ assignee.last_name|first|upper }}</span>
                                        </div>
                                        <span class="ml-2 text-sm text-gray-900 dark:text-white">{{ assignee.get_full_name }}</span>
                                        {% empty %}
                                        <span class="text-sm text-gray-500 dark:text-gray-400">Unassigned</span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    {% if task.deadline %}
                                        {% if task.deadline.date < today %}
                                            <span class="chip date-overdue">Overdue</span>
                                        {% elif task.deadline.date == today %}
                                            <span class="chip date-due-today">Due Today</span>
                                        {% elif task.deadline.date <= today|add:7 %}
                                            <span class="chip date-due-soon">Due Soon</span>
                                        {% else %}
                                            <span class="chip date-due-later">Due Later</span>
                                        {% endif %}
                                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ task.deadline|date:"M j, Y" }}</div>
                                    {% else %}
                                        <span class="text-sm text-gray-500 dark:text-gray-400">No deadline</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap">
                                    <span class="text-sm text-gray-900 dark:text-white">{{ task.category.project.name }}</span>
                                </td>
                                <td class="px-2 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="{% url 'main:task_crud' task.id %}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 transition-colors duration-150">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <div class="text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-tasks text-4xl mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No tasks found</h3>
                                        <p class="text-sm">Get started by creating your first task.</p>
                                        <div class="mt-4">
                                            <a href="{% url 'main:task_crud' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                <i class="fas fa-plus -ml-1 mr-2"></i>
                                                New Task
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Card View -->
        <div id="cardView" class="card-view">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for task in tasks %}
                <div class="task-item bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700{% if task.status == 'completed' %} opacity-50 line-through{% endif %}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" 
                                   class="task-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700" 
                                   data-task-id="{{ task.id }}"
                                   {% if task.status == 'completed' %}checked{% endif %}>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                                    <a href="{% url 'main:task_detail' task.id %}" class="hover:text-primary-600 dark:hover:text-primary-400">{{ task.title }}</a>
                                </h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">{{ task.description|truncatechars:100 }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="chip status-{{ task.status|default:'todo' }}">{{ task.get_status_display }}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Priority</span>
                            <span class="chip priority-{{ task.priority|default:'medium' }}">{{ task.get_priority_display }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Project</span>
                            <span class="text-sm text-gray-900 dark:text-white">{{ task.category.project.name }}</span>
                        </div>
                        {% if task.deadline %}
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Due Date</span>
                            <span class="text-sm {% if task.deadline.date < today %}text-red-600 dark:text-red-400{% elif task.deadline.date == today %}text-orange-600 dark:text-orange-400{% else %}text-gray-900 dark:text-white{% endif %}">
                                {{ task.deadline|date:"M j, Y" }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-2">
                            {% for assignee in task.assignees.all|slice:":3" %}
                            <div class="w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300">
                                {{ assignee.first_name|first|upper }}{{ assignee.last_name|first|upper }}
                            </div>
                            {% endfor %}
                            {% if task.assignees.count > 3 %}
                            <div class="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-medium text-gray-600 dark:text-gray-400">
                                +{{ task.assignees.count|add:"-3" }}
                            </div>
                            {% endif %}
                        </div>
                        <a href="{% url 'main:task_crud' task.id %}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 transition-colors duration-150">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-12">
                    <div class="text-gray-500 dark:text-gray-400">
                        <i class="fas fa-tasks text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No tasks found</h3>
                        <p class="text-sm">Get started by creating your first task.</p>
                        <div class="mt-4">
                            <a href="{% url 'main:task_crud' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-plus -ml-1 mr-2"></i>
                                New Task
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if tasks.has_other_pages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700 dark:text-gray-300">
                Showing <span class="font-medium">{{ tasks.start_index }}</span> to <span class="font-medium">{{ tasks.end_index }}</span> of <span class="font-medium">{{ tasks.paginator.count }}</span> tasks
            </div>
            <div class="flex space-x-2">
                {% if tasks.has_previous %}
                    <a href="?page={{ tasks.previous_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                        Previous
                    </a>
                {% else %}
                    <button class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Previous
                    </button>
                {% endif %}
                
                {% for num in tasks.paginator.page_range %}
                    {% if tasks.number == num %}
                        <span class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md">{{ num }}</span>
                    {% elif num > tasks.number|add:'-3' and num < tasks.number|add:'3' %}
                        <a href="?page={{ num }}" class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                            {{ num }}
                        </a>
                    {% endif %}
                {% endfor %}
                
                {% if tasks.has_next %}
                    <a href="?page={{ tasks.next_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                        Next
                    </a>
                {% else %}
                    <button class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Next
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View toggle functionality
    const tableViewBtn = document.getElementById('tableViewBtn');
    const cardViewBtn = document.getElementById('cardViewBtn');
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');
    
    // Load saved view preference
    const savedView = localStorage.getItem('taskView') || 'table';
    setView(savedView);
    
    function setView(view) {
        // Update buttons
        if (view === 'table') {
            tableViewBtn.classList.add('bg-indigo-600', 'text-white');
            tableViewBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
            cardViewBtn.classList.remove('bg-indigo-600', 'text-white');
            cardViewBtn.classList.add('text-gray-600', 'dark:text-gray-400');
        } else {
            cardViewBtn.classList.add('bg-indigo-600', 'text-white');
            cardViewBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
            tableViewBtn.classList.remove('bg-indigo-600', 'text-white');
            tableViewBtn.classList.add('text-gray-600', 'dark:text-gray-400');
        }
        
        // Update content
        tableView.classList.toggle('active', view === 'table');
        cardView.classList.toggle('active', view === 'card');
        
        // Save preference
        localStorage.setItem('taskView', view);
    }
    
    tableViewBtn.addEventListener('click', () => setView('table'));
    cardViewBtn.addEventListener('click', () => setView('card'));
    
    // Dropdown functionality
    const dropdowns = document.querySelectorAll('.dropdown');
    
    dropdowns.forEach(dropdown => {
        const toggle = dropdown.querySelector('.dropdown-toggle');
        const menu = dropdown.querySelector('.dropdown-menu');
        const items = dropdown.querySelectorAll('.dropdown-item');
        
        // Close all dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                menu.classList.remove('show');
            }
        });
        
        toggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Close other dropdowns
            dropdowns.forEach(otherDropdown => {
                if (otherDropdown !== dropdown) {
                    otherDropdown.querySelector('.dropdown-menu').classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('show');
        });
        
        items.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const value = item.dataset.value;
                const text = item.textContent;
                const textElement = toggle.querySelector('span');
                
                // Update button text
                textElement.textContent = text;
                
                // Update selected state
                items.forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                
                // Close dropdown
                menu.classList.remove('show');
                
                // Apply filters immediately
                applyFilters();
            });
        });
    });
    
    // Initialize dropdown states from URL parameters
    initializeFilters();
    
    function initializeFilters() {
        const urlParams = new URLSearchParams(window.location.search);
        const filters = ['status', 'priority', 'project', 'assignee', 'due_date', 'tags'];
        
        filters.forEach(filterName => {
            const value = urlParams.get(filterName);
            if (value) {
                const dropdown = document.querySelector(`[data-dropdown="${filterName}Filter"]`);
                if (dropdown) {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    const item = menu.querySelector(`[data-value="${value}"]`);
                    if (item) {
                        const textElement = dropdown.querySelector('span');
                        textElement.textContent = item.textContent;
                        
                        // Update selected state
                        menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    }
                }
            }
        });
        
        // Initialize search input
        const searchValue = urlParams.get('search');
        if (searchValue) {
            document.getElementById('search').value = searchValue;
        }
    }
    
    // Filter functionality
    const searchInput = document.getElementById('search');
    
    function applyFilters() {
        const searchValue = document.getElementById('search').value;
        const statusValue = getDropdownValue('statusFilter');
        const priorityValue = getDropdownValue('priorityFilter');
        const projectValue = getDropdownValue('projectFilter');
        const assigneeValue = getDropdownValue('assigneeFilter');
        const dueDateValue = getDropdownValue('dueDateFilter');
        const tagsValue = getDropdownValue('tagsFilter');
        
        const params = new URLSearchParams();
        
        if (searchValue) params.set('search', searchValue);
        if (statusValue) params.set('status', statusValue);
        if (priorityValue) params.set('priority', priorityValue);
        if (projectValue) params.set('project', projectValue);
        if (assigneeValue) params.set('assignee', assigneeValue);
        if (dueDateValue) params.set('due_date', dueDateValue);
        if (tagsValue) params.set('tags', tagsValue);
        
        // Redirect with filters
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    }
    
    function getDropdownValue(dropdownId) {
        const dropdown = document.querySelector(`[data-dropdown="${dropdownId}"]`);
        if (dropdown) {
            const selectedItem = dropdown.querySelector('.dropdown-item.selected');
            return selectedItem ? selectedItem.dataset.value : '';
        }
        return '';
    }
    
    // Event listeners
    document.getElementById('search').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('applyFilters').addEventListener('click', (e) => {
        e.preventDefault();
        applyFilters();
    });
    
    document.getElementById('clearFilters').addEventListener('click', (e) => {
        e.preventDefault();
        // Clear all dropdowns
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const firstItem = dropdown.querySelector('.dropdown-item');
            if (firstItem) {
                const textElement = dropdown.querySelector('span');
                textElement.textContent = firstItem.textContent;
                
                dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
                firstItem.classList.add('selected');
            }
        });
        
        // Clear search
        document.getElementById('search').value = '';
        
        // Apply filters
        applyFilters();
    });
    
    // Save filter button
    document.getElementById('saveFilterBtn').addEventListener('click', (e) => {
        e.preventDefault();
        // Save current filter state to localStorage
        const filterState = {
            search: document.getElementById('search').value,
            status: getDropdownValue('statusFilter'),
            priority: getDropdownValue('priorityFilter'),
            project: getDropdownValue('projectFilter'),
            assignee: getDropdownValue('assigneeFilter'),
            due_date: getDropdownValue('dueDateFilter'),
            tags: getDropdownValue('tagsFilter')
        };
        localStorage.setItem('savedFilters', JSON.stringify(filterState));
        alert('Filters saved successfully!');
    });
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Select all functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
    
    selectAllCheckbox.addEventListener('change', function() {
        taskCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    });
    
    // Individual checkbox change with AJAX functionality
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const completed = this.checked;
            
            // Disable checkbox while processing
            this.disabled = true;
            
            // Send AJAX request
            fetch('{% url "main:toggle_task_completion" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    task_id: taskId,
                    completed: completed
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the task item appearance based on completion status
                    const taskItem = this.closest('.task-item');
                    if (completed) {
                        // Add completed styling
                        taskItem.classList.add('opacity-50', 'line-through');
                    } else {
                        // Remove completed styling
                        taskItem.classList.remove('opacity-50', 'line-through');
                    }
                    
                    // Show success message
                    showNotification('Task ' + (completed ? 'completed' : 'marked as incomplete') + '!', 'success');
                } else {
                    // Revert checkbox state on error
                    this.checked = !completed;
                    showNotification('Error updating task: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                // Revert checkbox state on error
                this.checked = !completed;
                showNotification('Error updating task: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable checkbox
                this.disabled = false;
            });
            
            // Update select all checkbox state
            const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
            selectAllCheckbox.checked = checkedBoxes.length === taskCheckboxes.length;
        });
    });
    
    // Simple notification function
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 transition-all duration-300 ${
            type === 'success' 
                ? 'bg-green-500 text-white' 
                : 'bg-red-500 text-white'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
