{% extends 'base.html' %}

{% block title %}{{ task.title }} - AI Taskboard{% endblock %}

{% block extra_css %}
<style>
    .rich-text {
        min-height: 150px;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.75rem;
    }
    .rich-text:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
    }
    .attachment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 11px;
        top: 24px;
        height: calc(100% - 24px);
        width: 2px;
        background-color: #e2e8f0;
    }
    .mention {
        background-color: #dbeafe;
        color: #1d4ed8;
        padding: 0 2px;
        border-radius: 3px;
    }
    .prose {
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
    }
    @media (max-width: 768px) {
        .sticky-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 0.75rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 50;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Header Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div class="flex-1 min-w-[200px]">
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">{{ task.title }}</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Task ID: {{ task.id }}</p>
            </div>
            
            <div class="flex items-center gap-3 flex-wrap">
                <div class="relative">
                    <select id="status-dropdown" class="appearance-none bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 pl-3 pr-8 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100">
                        <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
                        <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="review" {% if task.status == 'review' %}selected{% endif %}>In Review</option>
                        <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                
                <div class="flex items-center gap-1">
                    <button id="priority-btn" class="flex items-center gap-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-2 rounded-md text-sm font-medium text-gray-900 dark:text-gray-100">
                        <span class="w-3 h-3 rounded-full {% if task.priority == 'urgent' %}bg-red-500{% elif task.priority == 'high' %}bg-orange-500{% elif task.priority == 'medium' %}bg-yellow-500{% else %}bg-green-500{% endif %}"></span>
                        <span>{{ task.get_priority_display }}</span>
                        <i class="fas fa-chevron-down text-xs ml-1"></i>
                    </button>
                    <div id="priority-menu" class="hidden absolute mt-2 w-40 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                        <div class="py-1">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-priority="low">
                                <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-2"></span>Low
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-priority="medium">
                                <span class="w-2 h-2 rounded-full bg-yellow-500 inline-block mr-2"></span>Medium
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-priority="high">
                                <span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-2"></span>High
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-priority="urgent">
                                <span class="w-2 h-2 rounded-full bg-purple-500 inline-block mr-2"></span>Urgent
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Button -->
                <a href="{% url 'main:task_crud' task.id %}" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                    <i class="fas fa-edit"></i>
                    Edit Task
                </a>
                
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Due:</span>
                    <span class="text-sm font-medium text-gray-900 dark:text-white">
                        {% if task.deadline %}
                            {{ task.deadline|date:"M j, Y" }}
                        {% else %}
                            No deadline
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Project and Category Info -->
        <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
            <div class="flex items-center gap-2">
                <i class="fas fa-project-diagram"></i>
                <a href="{% url 'main:project_detail' task.category.project.id %}" class="hover:text-blue-600 dark:hover:text-blue-400">{{ task.category.project.name }}</a>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-tag"></i>
                <span>{{ task.category.name }}</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Description -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Description</h2>
                <div class="prose dark:prose-invert max-w-none">
                    {% if task.description %}
                        {{ task.description|linebreaks }}
                    {% else %}
                        <p class="text-gray-500 dark:text-gray-400 italic">No description provided.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Assignees -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Assignees</h2>
                <div class="flex flex-wrap gap-3">
                    {% for assignee in task.assignees.all %}
                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
                        <div class="h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ assignee.first_name|first|upper }}{{ assignee.last_name|first|upper }}</span>
                        </div>
                        <span class="text-sm text-gray-900 dark:text-white">{{ assignee.get_full_name }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 dark:text-gray-400 italic">No assignees</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Comments -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Comments</h2>
                
                <!-- Add Comment Form -->
                <form method="post" action="{% url 'main:task_detail' task.id %}" class="mb-6">
                    {% csrf_token %}
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <textarea name="content" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Add a comment..."></textarea>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Comments List -->
                <div class="space-y-4">
                    {% for comment in task.comments.all %}
                    <div class="flex gap-3">
                        <div class="h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ comment.author.first_name|first|upper }}{{ comment.author.last_name|first|upper }}</span>
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">{{ comment.author.get_full_name }}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">{{ comment.content|linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 dark:text-gray-400 italic text-center py-4">No comments yet. Be the first to comment!</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Attachments -->
            {% if task.attachments.all %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Attachments</h2>
                <div class="attachment-grid">
                    {% for attachment in task.attachments.all %}
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                        <i class="fas fa-file text-2xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-900 dark:text-white truncate">{{ attachment.file.name|slice:"20:" }}</p>
                        <a href="{{ attachment.file.url }}" class="text-xs text-blue-600 dark:text-blue-400 hover:underline" target="_blank">Download</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Task Info -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Task Details</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                        <p class="text-sm text-gray-900 dark:text-white">{{ task.get_status_display }}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                        <p class="text-sm text-gray-900 dark:text-white">{{ task.get_priority_display }}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Created</label>
                        <p class="text-sm text-gray-900 dark:text-white">{{ task.created_at|date:"M j, Y" }}</p>
                    </div>
                    {% if task.deadline %}
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</label>
                        <p class="text-sm text-gray-900 dark:text-white">{{ task.deadline|date:"M j, Y" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dependencies -->
            {% if task.dependencies.all %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-link mr-2 text-indigo-500"></i>
                    Dependencies
                </h3>
                <div class="space-y-3">
                    {% for dependency in task.dependencies.all %}
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <a href="{% url 'main:task_detail' dependency.depends_on.id %}" class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline">
                                    {{ dependency.depends_on.title }}
                                </a>
                                <div class="mt-1 flex items-center gap-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                        {% if dependency.depends_on.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                        {% elif dependency.depends_on.status == 'in_progress' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                        {% elif dependency.depends_on.status == 'review' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                        {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                        {{ dependency.depends_on.get_status_display }}
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ dependency.depends_on.category.project.name }}</span>
                                </div>
                            </div>
                            {% if dependency.depends_on.status == 'completed' %}
                            <i class="fas fa-check-circle text-green-500 text-sm"></i>
                            {% else %}
                            <i class="fas fa-clock text-gray-400 text-sm"></i>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Activity Timeline -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Activity</h3>
                <div class="space-y-4">
                    {% for activity in task.activities.all|slice:":5" %}
                    <div class="flex gap-3 relative timeline-item">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-medium">A</div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-800 dark:text-white">{{ activity.description }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">{{ activity.created_at|timesince }} ago</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 dark:text-gray-400 italic text-center py-4">No activity yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status update
    const statusDropdown = document.getElementById('status-dropdown');
    if (statusDropdown) {
        statusDropdown.addEventListener('change', function() {
            const newStatus = this.value;
            fetch('{% url "main:update_task_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    task_id: {{ task.id }},
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message or update UI
                    console.log('Status updated successfully');
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
            });
        });
    }

    // Priority menu toggle
    const priorityBtn = document.getElementById('priority-btn');
    const priorityMenu = document.getElementById('priority-menu');
    
    if (priorityBtn && priorityMenu) {
        priorityBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            priorityMenu.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function() {
            priorityMenu.classList.add('hidden');
        });

        // Priority selection
        priorityMenu.addEventListener('click', function(e) {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                const priority = e.target.dataset.priority;
                
                // Update priority via AJAX
                fetch('{% url "main:update_task_priority" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        task_id: {{ task.id }},
                        priority: priority
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the priority button display
                        const priorityBtn = document.getElementById('priority-btn');
                        
                        // Get the priority text from the clicked link
                        const priorityTextContent = e.target.textContent.trim();
                        
                        // Determine the dot color
                        const dotColor = priority === 'urgent' ? 'bg-red-500' : 
                                       priority === 'high' ? 'bg-orange-500' : 
                                       priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500';
                        
                        // Update the entire button content
                        priorityBtn.innerHTML = `
                            <span class="w-3 h-3 rounded-full ${dotColor}"></span>
                            <span>${priorityTextContent}</span>
                            <i class="fas fa-chevron-down text-xs ml-1"></i>
                        `;
                        
                        // Update the sidebar priority display
                        const sidebarPriority = document.querySelector('.space-y-3 div:nth-child(2) p');
                        if (sidebarPriority) {
                            sidebarPriority.textContent = priorityTextContent;
                        }
                        
                        // Force a re-render by adding a temporary class
                        priorityBtn.style.transition = 'all 0.2s ease';
                        priorityBtn.classList.add('opacity-50');
                        setTimeout(() => {
                            priorityBtn.classList.remove('opacity-50');
                        }, 100);
                        
                        console.log('Priority updated successfully to:', priority);
                    } else {
                        console.error('Failed to update priority:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating priority:', error);
                });
                
                priorityMenu.classList.add('hidden');
            }
        });
    }
});
</script>
{% endblock %}