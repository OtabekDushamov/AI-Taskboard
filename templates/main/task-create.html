{% extends 'base.html' %}

{% block title %}Create New Task - AI Taskboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .dropzone {
        border: 2px dashed #cbd5e0;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
    }
    .dropzone.active {
        border-color: #4299e1;
        background-color: #ebf8ff;
    }
    .tag {
        display: inline-flex;
        align-items: center;
        background-color: #e2e8f0;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .tag-remove {
        margin-left: 0.5rem;
        cursor: pointer;
        color: #718096;
    }
    .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        transform: translateX(150%);
        transition: transform 0.3s ease-in-out;
        z-index: 1000;
    }
    .toast.show {
        transform: translateX(0);
    }
    .select2-container {
        width: 100% !important;
    }
    .tox-tinymce {
        border-radius: 0.375rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
        <div class="bg-indigo-600 px-6 py-4">
            <h1 class="text-2xl font-bold text-white">Create New Task</h1>
        </div>
        
        <form id="taskForm" class="p-6">
            <!-- Title -->
            <div class="mb-6">
                <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title *</label>
                <input type="text" id="title" name="title" required 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    placeholder="Enter task title">
                <p class="mt-1 text-sm text-red-600 hidden" id="title-error">Title is required</p>
            </div>
            
            <!-- Description (Rich Text) -->
            <div class="mb-6">
                <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                <textarea id="description" name="description" class="w-full border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Project -->
                <div>
                    <label for="project" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
                    <select id="project" name="project" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select project</option>
                        <option value="1">Website Redesign</option>
                        <option value="2">Mobile App Development</option>
                        <option value="3">Marketing Campaign</option>
                        <option value="4">Product Launch</option>
                    </select>
                </div>
                
                <!-- Category -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                    <select id="category" name="category" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select category</option>
                        <option value="design">Design</option>
                        <option value="development">Development</option>
                        <option value="marketing">Marketing</option>
                        <option value="support">Support</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Assignees (Multi-select) -->
                <div>
                    <label for="assignees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assignees</label>
                    <select id="assignees" name="assignees" multiple 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="1">John Doe</option>
                        <option value="2">Jane Smith</option>
                        <option value="3">Mike Johnson</option>
                        <option value="4">Sarah Williams</option>
                        <option value="5">David Brown</option>
                    </select>
                </div>
                
                <!-- Priority -->
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                    <select id="priority" name="priority" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Status -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                    <select id="status" name="status" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="todo">To Do</option>
                        <option value="in_progress">In Progress</option>
                        <option value="in_review">In Review</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                
                <!-- Estimate (hours) -->
                <div>
                    <label for="estimate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimate (hours)</label>
                    <input type="number" id="estimate" name="estimate" min="0" step="0.5" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                        placeholder="Estimated hours">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Due Date -->
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                    <input type="text" id="due_date" name="due_date" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                        placeholder="Select date">
                </div>
                
                <!-- Labels (Tags) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Labels</label>
                    <div class="flex">
                        <input type="text" id="tag_input" 
                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="Add label">
                        <button type="button" id="add_tag" class="px-4 py-2 bg-indigo-600 text-white rounded-r-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add
                        </button>
                    </div>
                    <div id="tags_container" class="mt-2 flex flex-wrap"></div>
                    <input type="hidden" id="tags" name="tags">
                </div>
            </div>
            
            <!-- Dependencies -->
            <div class="mb-6">
                <label for="dependencies" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dependencies</label>
                <select id="dependencies" name="dependencies" multiple 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <option value="1">Task #1: Setup Development Environment</option>
                    <option value="2">Task #2: Design System Components</option>
                    <option value="3">Task #3: API Documentation</option>
                </select>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select tasks that must be completed before this one</p>
            </div>
            
            <!-- Attachments -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments</label>
                <div id="dropzone" class="dropzone">
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400">Drag and drop files here, or <span class="text-indigo-600 dark:text-indigo-400 cursor-pointer" id="browse_files">browse</span></p>
                        <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">Max file size: 10MB</p>
                    </div>
                    <input type="file" id="file_input" multiple class="hidden" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
                </div>
                <div id="file_list" class="mt-2 space-y-2"></div>
            </div>
            
            <!-- Subtasks -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subtasks</label>
                <div class="space-y-2" id="subtasks_container">
                    <div class="flex items-center space-x-2">
                        <input type="text" name="subtasks[]" 
                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="Enter subtask">
                        <button type="button" class="px-3 py-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="removeSubtask(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button type="button" id="add_subtask" class="mt-2 px-4 py-2 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 border border-indigo-600 dark:border-indigo-400 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-900/20">
                    <i class="fas fa-plus mr-1"></i> Add Subtask
                </button>
            </div>
            
            <!-- Notes -->
            <div class="mb-6">
                <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Additional Notes</label>
                <textarea id="notes" name="notes" rows="3" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    placeholder="Any additional information or context..."></textarea>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="save_draft" class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save as Draft
                </button>
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Create Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
    <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toast-message">Task created successfully!</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.tiny.cloud/1/YOUR_API_KEY/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    // Initialize TinyMCE
    tinymce.init({
        selector: '#description',
        height: 300,
        menubar: false,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help',
        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }'
    });

    // Initialize Flatpickr for date picker
    flatpickr("#due_date", {
        dateFormat: "Y-m-d",
        minDate: "today",
        allowInput: true
    });

    // Global variables
    let tags = [];
    let files = [];

    // DOM elements
    const taskForm = document.getElementById('taskForm');
    const tagInput = document.getElementById('tag_input');
    const addTagBtn = document.getElementById('add_tag');
    const tagsContainer = document.getElementById('tags_container');
    const tagsHidden = document.getElementById('tags');
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file_input');
    const fileList = document.getElementById('file_list');
    const browseFiles = document.getElementById('browse_files');
    const addSubtaskBtn = document.getElementById('add_subtask');
    const subtasksContainer = document.getElementById('subtasks_container');
    const saveDraftBtn = document.getElementById('save_draft');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast_message');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        setupDragAndDrop();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Add tag
        addTagBtn.addEventListener('click', addTag);
        tagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        });

        // Add subtask
        addSubtaskBtn.addEventListener('click', addSubtask);

        // File input
        browseFiles.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        // Form submission
        taskForm.addEventListener('submit', handleFormSubmit);
        saveDraftBtn.addEventListener('click', saveDraft);
    }

    // Add tag functionality
    function addTag() {
        const tagText = tagInput.value.trim();
        if (tagText && !tags.includes(tagText)) {
            tags.push(tagText);
            renderTags();
            tagInput.value = '';
            updateTagsHidden();
        }
    }

    // Render tags
    function renderTags() {
        tagsContainer.innerHTML = '';
        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag';
            tagElement.innerHTML = `
                ${tag}
                <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
            `;
            tagsContainer.appendChild(tagElement);
        });
    }

    // Remove tag
    function removeTag(tagToRemove) {
        tags = tags.filter(tag => tag !== tagToRemove);
        renderTags();
        updateTagsHidden();
    }

    // Update hidden tags input
    function updateTagsHidden() {
        tagsHidden.value = tags.join(',');
    }

    // Add subtask functionality
    function addSubtask() {
        const subtaskDiv = document.createElement('div');
        subtaskDiv.className = 'flex items-center space-x-2';
        subtaskDiv.innerHTML = `
            <input type="text" name="subtasks[]" 
                class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                placeholder="Enter subtask">
            <button type="button" class="px-3 py-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="removeSubtask(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        subtasksContainer.appendChild(subtaskDiv);
    }

    // Remove subtask
    function removeSubtask(button) {
        button.parentElement.remove();
    }

    // Setup drag and drop
    function setupDragAndDrop() {
        dropzone.addEventListener('dragover', handleDragOver);
        dropzone.addEventListener('dragleave', handleDragLeave);
        dropzone.addEventListener('drop', handleDrop);
    }

    function handleDragOver(e) {
        e.preventDefault();
        dropzone.classList.add('active');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropzone.classList.remove('active');
    }

    function handleDrop(e) {
        e.preventDefault();
        dropzone.classList.remove('active');
        
        const droppedFiles = Array.from(e.dataTransfer.files);
        handleFiles(droppedFiles);
    }

    // Handle file selection
    function handleFileSelect(e) {
        const selectedFiles = Array.from(e.target.files);
        handleFiles(selectedFiles);
    }

    // Process files
    function handleFiles(fileList) {
        fileList.forEach(file => {
            if (file.size <= 10 * 1024 * 1024) { // 10MB limit
                files.push(file);
                renderFile(file);
            } else {
                showToast('File too large: ' + file.name, 'error');
            }
        });
    }

    // Render file in list
    function renderFile(file) {
        const fileElement = document.createElement('div');
        fileElement.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded';
        fileElement.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-file mr-2 text-gray-500"></i>
                <span class="text-sm text-gray-700 dark:text-gray-300">${file.name}</span>
                <span class="text-xs text-gray-500 ml-2">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
            </div>
            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeFile('${file.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileElement);
    }

    // Remove file
    function removeFile(fileName) {
        files = files.filter(file => file.name !== fileName);
        renderFileList();
    }

    // Render file list
    function renderFileList() {
        fileList.innerHTML = '';
        files.forEach(file => renderFile(file));
    }

    // Handle form submission
    function handleFormSubmit(e) {
        e.preventDefault();
        
        if (validateForm()) {
            const formData = new FormData(taskForm);
            
            // Add files to form data
            files.forEach(file => {
                formData.append('attachments[]', file);
            });
            
            // In a real app, this would send an API request
            console.log('Submitting task:', Object.fromEntries(formData));
            
            showToast('Task created successfully!', 'success');
            
            // Reset form
            setTimeout(() => {
                taskForm.reset();
                tags = [];
                files = [];
                renderTags();
                renderFileList();
                tinymce.get('description').setContent('');
            }, 2000);
        }
    }

    // Save as draft
    function saveDraft() {
        const formData = new FormData(taskForm);
        formData.append('status', 'draft');
        
        // In a real app, this would save to localStorage or send to API
        console.log('Saving draft:', Object.fromEntries(formData));
        
        showToast('Draft saved successfully!', 'success');
    }

    // Validate form
    function validateForm() {
        const title = document.getElementById('title').value.trim();
        const titleError = document.getElementById('title-error');
        
        if (!title) {
            titleError.classList.remove('hidden');
            return false;
        }
        
        titleError.classList.add('hidden');
        return true;
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        
        // Update toast styling based on type
        toast.className = 'toast px-6 py-3 rounded-lg shadow-lg';
        if (type === 'success') {
            toast.classList.add('bg-green-500', 'text-white');
        } else if (type === 'error') {
            toast.classList.add('bg-red-500', 'text-white');
        } else {
            toast.classList.add('bg-blue-500', 'text-white');
        }
        
        // Show toast
        toast.classList.add('show');
        
        // Hide after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
{% endblock %}