<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Telegram WebApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -468px 0 }
            100% { background-position: 468px 0 }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .skeleton {
            background: linear-gradient(to right, #eee 8%, #ddd 18%, #eee 33%);
            background-size: 800px 104px;
            animation: shimmer 1.5s infinite linear;
        }
        
        .toast {
            transition: all 0.3s ease;
            transform: translateY(100%);
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        /* Dark mode overrides */
        .dark .skeleton {
            background: linear-gradient(to right, #333 8%, #444 18%, #333 33%);
        }
        
        /* For browsers that support prefers-color-scheme */
        @media (prefers-color-scheme: dark) {
            .dark-mode-auto {
                background-color: #1a202c;
                color: #e2e8f0;
            }
            
            .dark-mode-auto .bg-white {
                background-color: #2d3748 !important;
            }
            
            .dark-mode-auto .text-gray-800 {
                color: #e2e8f0 !important;
            }
            
            .dark-mode-auto .text-gray-600 {
                color: #a0aec0 !important;
            }
            
            .dark-mode-auto .border-gray-200 {
                border-color: #4a5568 !important;
            }
        }
    </style>
</head>
<body class="dark-mode-auto bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 pb-6 max-w-3xl">
        <main>
            <!-- Profile Card -->
            <section class="mt-6 fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 text-center">
                    <!-- Avatar -->
                    <div class="relative mx-auto w-24 h-24 mb-4">
                        <div id="avatar" class="w-full h-full rounded-full bg-blue-500 flex items-center justify-center text-white text-3xl font-bold skeleton"></div>
                    </div>
                    
                    <!-- Name -->
                    <h2 id="fullName" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-1 skeleton h-8 w-48 mx-auto"></h2>
                    
                    <!-- Username -->
                    <div id="username" class="text-gray-600 dark:text-gray-400 mb-2 skeleton h-6 w-32 mx-auto"></div>
                    
                    <!-- Language -->
                    <div id="language" class="text-gray-500 dark:text-gray-400 text-sm mt-3 skeleton h-5 w-16 mx-auto hidden"></div>
                </div>
            </section>

            <!-- Info Grid -->
            <section class="mt-6 fade-in" style="animation-delay: 0.1s">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-6">
                        <!-- First Name -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">First name</p>
                            <p id="firstName" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                        
                        <!-- Last Name -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Last name</p>
                            <p id="lastName" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                        
                        <!-- Username -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Username</p>
                            <p id="usernameGrid" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                        
                        <!-- Telegram ID -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Telegram ID</p>
                            <p id="telegramIdGrid" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                        
                        <!-- Language -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Language</p>
                            <p id="languageGrid" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                        
                        <!-- Joined Date -->
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Joined</p>
                            <p id="joinedDate" class="text-gray-800 dark:text-gray-200 skeleton h-6 w-32"></p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check for Telegram WebApp data
            const tg = window.Telegram?.WebApp;
            const tUser = tg?.initDataUnsafe?.user;
            
            if (tUser) {
                // Use Telegram user data
                loadUserData(tUser);
                // Fetch additional data from backend
                fetchUserDataFromBackend(tUser.id);
            } else {
                // Fetch user data from backend
                fetchUserDataFromBackend();
            }
        });

        // Fetch user data from backend
        function fetchUserDataFromBackend(telegramId = null) {
            const url = telegramId ? `/webapp/users/${telegramId}/` : '/profile/';
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user) {
                    loadUserData(data.user);
                } else {
                    console.error('Failed to fetch user data:', data.message);
                    showError('Failed to load profile data');
                }
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                showError('Error loading profile data');
            });
        }

        // Load user data into the UI
        function loadUserData(user) {
            // Remove skeleton loading classes
            const skeletonElements = document.querySelectorAll('.skeleton');
            skeletonElements.forEach(el => el.classList.remove('skeleton'));
            
            // Avatar
            const avatarEl = document.getElementById('avatar');
            if (user.profile_image) {
                avatarEl.innerHTML = '';
                avatarEl.style.backgroundImage = `url(${user.profile_image})`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                avatarEl.setAttribute('alt', `Profile photo of ${user.first_name} ${user.last_name || ''}`.trim());
            } else {
                const initials = (user.first_name ? user.first_name.charAt(0) : '') + (user.last_name ? user.last_name.charAt(0) : '');
                avatarEl.innerHTML = initials || '?';
                avatarEl.style.backgroundColor = getColorFromId(user.telegram_id || user.id);
            }
            
            // Name
            document.getElementById('fullName').textContent = `${user.first_name} ${user.last_name || ''}`.trim();
            
            // Username
            const usernameEl = document.getElementById('username');
            const usernameGridEl = document.getElementById('usernameGrid');
            if (user.username) {
                usernameEl.textContent = `@${user.username}`;
                usernameGridEl.textContent = `@${user.username}`;
            } else {
                usernameEl.textContent = '—';
                usernameGridEl.textContent = '—';
            }
            
            // Telegram ID
            const telegramIdGridEl = document.getElementById('telegramIdGrid');
            if (user.telegram_id) {
                telegramIdGridEl.textContent = user.telegram_id;
            } else {
                telegramIdGridEl.textContent = '—';
            }
            
            // Language
            const languageEl = document.getElementById('language');
            const languageGridEl = document.getElementById('languageGrid');
            if (user.language_code) {
                languageEl.textContent = user.language_code.toUpperCase();
                languageGridEl.textContent = user.language_code.toUpperCase();
                languageEl.classList.remove('hidden');
            } else {
                languageEl.textContent = '—';
                languageGridEl.textContent = '—';
                languageEl.classList.add('hidden');
            }
            
            // First Name
            document.getElementById('firstName').textContent = user.first_name || '—';
            
            // Last Name
            document.getElementById('lastName').textContent = user.last_name || '—';
            
            // Joined Date
            if (user.register_date) {
                const date = new Date(user.register_date);
                document.getElementById('joinedDate').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } else {
                document.getElementById('joinedDate').textContent = '—';
            }
        }

        // Show error message
        function showError(message) {
            console.error(message);
            // You can add a toast notification here if needed
        }

        // Generate a color based on user ID for avatar background
        function getColorFromId(id) {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', 
                '#98D8C8', '#F06292', '#7986CB', '#9575CD'
            ];
            return colors[Math.abs(id) % colors.length];
        }
    </script>
</body>
</html>